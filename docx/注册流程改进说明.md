# æ³¨å†Œæµç¨‹æ”¹è¿›è¯´æ˜

## ğŸ“‹ é—®é¢˜

ä¹‹å‰çš„æ³¨å†Œæµç¨‹åªåˆ›å»ºäº†è®¤è¯ä¿¡æ¯ï¼ˆAuthï¼‰ï¼Œæ²¡æœ‰è‡ªåŠ¨åˆ›å»ºç”¨æˆ·èµ„æ–™ï¼ˆUserï¼‰ï¼Œå¯¼è‡´ï¼š
- âŒ æ³¨å†Œåæ— æ³•æŸ¥è¯¢åˆ°ç”¨æˆ·èµ„æ–™
- âŒ éœ€è¦æ‰‹åŠ¨è°ƒç”¨åˆ›å»ºç”¨æˆ·æ¥å£
- âŒ Auth å’Œ User æ•°æ®ä¸ä¸€è‡´

## âœ… è§£å†³æ–¹æ¡ˆ

ç°åœ¨æ³¨å†Œæ—¶ä¼š**è‡ªåŠ¨åˆ›å»ºè®¤è¯ä¿¡æ¯å’Œç”¨æˆ·èµ„æ–™**ï¼Œç¡®ä¿æ•°æ®è”åŠ¨ã€‚

---

## ğŸ”„ æ–°çš„æ³¨å†Œæµç¨‹

```
ç”¨æˆ·æäº¤æ³¨å†Œ
    â†“
æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    â†“
åˆ›å»ºè®¤è¯è®°å½•ï¼ˆAuthï¼‰
    â”œâ”€ uuid: è‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†
    â”œâ”€ userName: ç”¨æˆ·å
    â”œâ”€ email: é‚®ç®±
    â””â”€ passwordHash: åŠ å¯†åçš„å¯†ç 
    â†“
åˆ›å»ºç”¨æˆ·èµ„æ–™ï¼ˆUserï¼‰
    â”œâ”€ userId: å…³è”åˆ° Auth çš„ uuid
    â”œâ”€ name: åˆå§‹ä¸ºç”¨æˆ·å
    â””â”€ preferences: é»˜è®¤åå¥½è®¾ç½®
    â†“
è¿”å›æˆåŠŸå“åº”ï¼ˆåŒ…å«è®¤è¯å’Œç”¨æˆ·èµ„æ–™ä¿¡æ¯ï¼‰
```

---

## ğŸ“Š æ•°æ®åº“è¡¨å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthenticateUser è¡¨    â”‚         â”‚  User è¡¨                 â”‚
â”‚  (è®¤è¯ä¿¡æ¯)             â”‚         â”‚  (ç”¨æˆ·èµ„æ–™)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ uuid (å”¯ä¸€æ ‡è¯†) â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ userId (å¤–é”®)            â”‚
â”‚ userName                â”‚         â”‚ name                     â”‚
â”‚ email                   â”‚         â”‚ age                      â”‚
â”‚ passwordHash            â”‚         â”‚ avatarUrl                â”‚
â”‚ role                    â”‚         â”‚ bio                      â”‚
â”‚ loginAttempts           â”‚         â”‚ location                 â”‚
â”‚ lockUntil               â”‚         â”‚ preferences              â”‚
â”‚ createdAt               â”‚         â”‚   - theme                â”‚
â”‚ updatedAt               â”‚         â”‚   - language             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ createdAt                â”‚
                                    â”‚ updatedAt                â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³è”æ–¹å¼: User.userId === Auth.uuid (ä¸€å¯¹ä¸€å…³ç³»)
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. **å…³äº MongoDB äº‹åŠ¡**

æœ€åˆçš„å®ç°ä½¿ç”¨äº† MongoDB äº‹åŠ¡æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼š

```typescript
// âŒ éœ€è¦å‰¯æœ¬é›†æ‰èƒ½ä½¿ç”¨
const session = await mongoose.startSession();
session.startTransaction();
// ... åˆ›å»ºæ•°æ®
await session.commitTransaction();
```

**é—®é¢˜**ï¼šå•æœºç‰ˆ MongoDB ä¸æ”¯æŒäº‹åŠ¡ï¼Œä¼šæŠ¥é”™ï¼š
```
Transaction numbers are only allowed on a replica set member or mongos
```

### 2. **å½“å‰è§£å†³æ–¹æ¡ˆï¼ˆæ— äº‹åŠ¡ç‰ˆæœ¬ï¼‰**

```typescript
// âœ… é€‚ç”¨äºå•æœº MongoDB
try {
  // 1. åˆ›å»ºè®¤è¯è®°å½•
  const auth = await AuthModel.save();
  
  try {
    // 2. åˆ›å»ºç”¨æˆ·èµ„æ–™
    const user = await User.save();
    return { auth, user };
  } catch (userError) {
    // 3. å¦‚æœç”¨æˆ·èµ„æ–™åˆ›å»ºå¤±è´¥ï¼Œæ‰‹åŠ¨åˆ é™¤è®¤è¯è®°å½•
    await AuthModel.findByIdAndDelete(auth._id);
    throw userError;
  }
} catch (error) {
  // å¤„ç†é”™è¯¯
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä¸éœ€è¦å‰¯æœ¬é›†ï¼Œé€‚åˆå¼€å‘ç¯å¢ƒ
- âœ… æœ‰ç®€å•çš„å›æ»šæœºåˆ¶ï¼ˆå¤±è´¥æ—¶åˆ é™¤å·²åˆ›å»ºçš„è®°å½•ï¼‰
- âš ï¸ ä¸æ˜¯åŸå­æ“ä½œï¼Œæç«¯æƒ…å†µä¸‹å¯èƒ½å‡ºç°ä¸ä¸€è‡´
- ğŸ’¡ ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å‰¯æœ¬é›† + äº‹åŠ¡

---

## ğŸ“ API å“åº”æ ¼å¼

### æ³¨å†ŒæˆåŠŸå“åº”

```json
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "userName": "john",
    "email": "john@example.com",
    "uuid": "123e4567-e89b-12d3-a456-426614174000",
    "profile": {
      "userId": "123e4567-e89b-12d3-a456-426614174000",
      "name": "john"
    }
  }
}
```

### æ³¨å†Œå¤±è´¥å“åº”

```json
{
  "success": false,
  "error": "ç”¨æˆ·åæˆ–é‚®ç®±å·²è¢«æ³¨å†Œ"
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æ³¨å†Œæ–°ç”¨æˆ·

```bash
POST http://localhost:3000/api/backend/auth/Register
Content-Type: application/json

{
  "userName": "testuser",
  "email": "test@example.com",
  "password": "123456"
}
```

### 2. éªŒè¯è®¤è¯è®°å½•

```javascript
// MongoDB Shell
use myapp
db.authenticateusers.findOne({ userName: "testuser" })
```

åº”è¯¥çœ‹åˆ°ï¼š
```javascript
{
  _id: ObjectId("..."),
  uuid: "123e4567-...",
  userName: "testuser",
  email: "test@example.com",
  passwordHash: "$2a$10$...",
  role: "user",
  createdAt: ISODate("..."),
  updatedAt: ISODate("...")
}
```

### 3. éªŒè¯ç”¨æˆ·èµ„æ–™

```javascript
// MongoDB Shell
db.users.findOne({ userId: "123e4567-..." })
```

åº”è¯¥çœ‹åˆ°ï¼š
```javascript
{
  _id: ObjectId("..."),
  userId: "123e4567-...",  // ä¸ auth.uuid ç›¸åŒ
  name: "testuser",
  preferences: {
    theme: "light",
    language: "zh-CN"
  },
  createdAt: ISODate("..."),
  updatedAt: ISODate("...")
}
```

### 4. æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨

```bash
GET http://localhost:3000/api/backend/user/
Authorization: Bearer <token>
```

åº”è¯¥èƒ½çœ‹åˆ°åˆšæ³¨å†Œçš„ç”¨æˆ·ã€‚

---

## ğŸ¯ ä¼˜åŠ¿

### âœ… æ•°æ®ä¸€è‡´æ€§
- æ³¨å†ŒæˆåŠŸåï¼ŒAuth å’Œ User æ•°æ®åŒæ—¶å­˜åœ¨
- ç”¨æˆ·å¯ä»¥ç«‹å³ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½

### âœ… ç®€åŒ–å‰ç«¯é€»è¾‘
```javascript
// å‰ç«¯åªéœ€è¦è°ƒç”¨ä¸€ä¸ªæ¥å£
const response = await register(userName, email, password);
// æ³¨å†ŒæˆåŠŸåï¼Œè®¤è¯ä¿¡æ¯å’Œç”¨æˆ·èµ„æ–™éƒ½å·²åˆ›å»º
```

### âœ… æ•°æ®å…³è”æ¸…æ™°
```javascript
// é€šè¿‡ uuid å…³è”ä¸¤ä¸ªè¡¨
const auth = await AuthModel.findOne({ email });
const user = await User.findOne({ userId: auth.uuid });
```

### âœ… è‡ªåŠ¨å›æ»š
- å¦‚æœç”¨æˆ·èµ„æ–™åˆ›å»ºå¤±è´¥ï¼Œä¼šè‡ªåŠ¨åˆ é™¤å·²åˆ›å»ºçš„è®¤è¯è®°å½•
- é¿å…è„æ•°æ®

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### æ–¹æ¡ˆä¸€ï¼šé…ç½® MongoDB å‰¯æœ¬é›†ï¼ˆæ¨èï¼‰

1. **å¯åŠ¨å‰¯æœ¬é›†**
```bash
# Windows (ä»¥ç®¡ç†å‘˜è¿è¡Œ)
mongod --replSet rs0 --port 27017 --dbpath C:\data\db

# åˆå§‹åŒ–å‰¯æœ¬é›†
mongosh
> rs.initiate()
```

2. **ä¿®æ”¹ä»£ç ä½¿ç”¨äº‹åŠ¡**
```typescript
const session = await mongoose.startSession();
session.startTransaction();
try {
  // ... åˆ›å»ºæ•°æ®
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
}
```

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨äº‘æ•°æ®åº“
- MongoDB Atlasï¼ˆå…è´¹ç‰ˆæ”¯æŒå‰¯æœ¬é›†ï¼‰
- é˜¿é‡Œäº‘ MongoDB
- è…¾è®¯äº‘ MongoDB

### æ–¹æ¡ˆä¸‰ï¼šç»§ç»­ä½¿ç”¨å½“å‰æ–¹æ¡ˆ
- é€‚åˆå°å‹åº”ç”¨
- éœ€è¦æ·»åŠ æ›´å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç›‘æ§

---

## ğŸ“š ç›¸å…³ä»£ç æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/services/authService.ts` | æ³¨å†Œé€»è¾‘å®ç° |
| `src/controllers/backend/authController.ts` | æ³¨å†Œæ¥å£å¤„ç† |
| `src/models/Auth.ts` | è®¤è¯æ¨¡å‹å®šä¹‰ |
| `src/models/user.ts` | ç”¨æˆ·æ¨¡å‹å®šä¹‰ |
| `src/routes/backend/auth.ts` | è·¯ç”±å’Œæ–‡æ¡£ |

---

## ğŸ’¡ åç»­æ”¹è¿›å»ºè®®

1. **æ·»åŠ å‚æ•°éªŒè¯**
   - ç”¨æˆ·åé•¿åº¦é™åˆ¶ï¼ˆ3-20å­—ç¬¦ï¼‰
   - å¯†ç å¼ºåº¦éªŒè¯ï¼ˆè‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰
   - é‚®ç®±æ ¼å¼éªŒè¯

2. **æ·»åŠ é‚®ç®±éªŒè¯**
   - å‘é€éªŒè¯é‚®ä»¶
   - ç‚¹å‡»é“¾æ¥æ¿€æ´»è´¦å·

3. **å®Œå–„é”™è¯¯å¤„ç†**
   - åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
   - è®°å½•è¯¦ç»†æ—¥å¿—

4. **æ·»åŠ é˜²é‡å¤æäº¤**
   - ä½¿ç”¨ Redis ç¼“å­˜æ­£åœ¨æ³¨å†Œçš„ç”¨æˆ·
   - é˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤æ³¨å†Œ

5. **ç›‘æ§æ•°æ®ä¸€è‡´æ€§**
   - å®šæœŸæ£€æŸ¥å­¤ç«‹çš„ Auth è®°å½•
   - å®šæœŸæ£€æŸ¥å­¤ç«‹çš„ User è®°å½•
   - æä¾›æ•°æ®ä¿®å¤å·¥å…·

---

## âœ¨ æ€»ç»“

ç°åœ¨ä½ çš„æ³¨å†Œæµç¨‹å·²ç»å®Œå–„äº†ï¼æ³¨å†Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºï¼š
1. âœ… è®¤è¯ä¿¡æ¯ï¼ˆAuthï¼‰- ç”¨äºç™»å½•éªŒè¯
2. âœ… ç”¨æˆ·èµ„æ–™ï¼ˆUserï¼‰- ç”¨äºå­˜å‚¨ç”¨æˆ·ä¿¡æ¯
3. âœ… ä¸¤è€…é€šè¿‡ uuid å…³è”

**ç«‹å³æµ‹è¯•**ï¼šè®¿é—® http://localhost:3000/api-docsï¼Œä½¿ç”¨ Swagger UI æµ‹è¯•æ³¨å†Œæ¥å£ï¼

